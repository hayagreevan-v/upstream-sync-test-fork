name: Upstream Auto Sync via PR
on:
  schedule:
    - cron: '0 0 * * *' # Runs daily.
  workflow_dispatch:  

jobs:
  upstream-sync:
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check and Sync Upstream
        id: sync_upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_REPO: "hayagreevan-presidio/upstream-sync-test-upstream"
          FORK_REPO: "hayagreevan-v/upstream-sync-test-fork"
        run: |
          # 1. Setup Git Identity (Required for merge commits)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 2. Setup upstream remote and fetch
          # We check if 'upstream' exists; if not, add it. If it does, update the URL.

          if ! git remote | grep -q 'upstream'; then
            echo "Adding upstream remote..."
            git remote add upstream https://github.com/${UPSTREAM_REPO}.git
          else
            echo "Upstream remote already exists, updating URL..."
            git remote set-url upstream https://github.com/${UPSTREAM_REPO}.git
          fi

          git fetch upstream main

          # 3. Checkout to upstream-main branch
          # This ensures we are merging upstream into our upstream-main branch
          git checkout upstream-main 

          # 4. Check if upstream is actually ahead of our main
          LOCAL_HASH=$(git rev-parse HEAD)
          UPSTREAM_HASH=$(git rev-parse upstream/main)

          if [ "$LOCAL_HASH" = "$UPSTREAM_HASH" ]; then
            echo "No changes found. Skipping sync."
            exit 0
          fi

          # 5. Check if a PR already exists with this title
          # We get the count of open PRs with this title
          PR_COUNT=$(gh pr list --repo $FORK_REPO --state open --search "Merge from Cline" --json id --jq '. | length')
          
          # 6. Merge upstream into the sync branch
          echo "New commits detected. Merging..."
          git merge upstream/main --no-edit
          
          # 7. Push the branch (use force-with-lease to update existing PR branch safely)
          git push origin upstream-main

          EXISTING_PR_URL=$(gh pr list --repo $FORK_REPO --state open --search "Merge from Cline" --json url --jq '.[0].url')

          if [ -z "$EXISTING_PR_URL" ]; then
            echo "Creating new Pull Request..."
            NEW_PR_URL=$(gh pr create \
              --repo $FORK_REPO \
              --title "Merge from Cline" \
              --body "This is an automated PR to sync changes from cline repo." \
              --base main \
              --head upstream-main)
            
            echo "pr_url=$NEW_PR_URL" >> $GITHUB_OUTPUT
            echo "pr_created=true" >> $GITHUB_OUTPUT
          else
            echo "Existing PR updated with new commits."
            echo "pr_url=$EXISTING_PR_URL" >> $GITHUB_OUTPUT
            echo "new_changes_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Send PR created Email Notification
        if: steps.sync_upstream.outputs.pr_created == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "New Upstream Sync PR for ${{ github.repository }}"
          to: drmarsqueen@gmail.com,hayagreevanvk@gmail.com
          from: HAI Build Codegen - GitHub Actions
          embedded_nodes: ../../hai_build_logo_light.png
          html_body: |
            <!DOCTYPE html>
            <html>
              <body style="font-family: Arial, sans-serif; color: #333;">
                <div style="max-width: 600px; margin: 20px auto; border: 1px solid #ddd; padding: 20px;">
                  <div style="text-align: center; margin-bottom: 20px;">
                    <img src="cid:hai_build_logo_light.png" alt="Header Logo" style="max-width: 200px;">
                  </div>
                  <h2 style="color: #2c3e50;">New Sync PR Raised</h2>
                  <p>New changes were found in the <b>Cline Repository</b>.</p>
                  <p>A new Pull Request has been automatically created to sync these changes.</p>
                  <div style="margin-top: 20px;">
                    <a href="${{ steps.sync_upstream.outputs.pr_url }}" 
                       style="background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                       View Pull Request
                    </a>
                  </div>
                </div>
              </body>
            </html>


      - name: Send New Changes found Email Notification
        if: steps.sync_upstream.outputs.new_changes_found == 'true' 
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Existing Sync PR Updated for ${{ github.repository }}"
          to: drmarsqueen@gmail.com,hayagreevanvk@gmail.com
          from: HAI Build Codegen - GitHub Actions
          embedded_nodes: ../../hai_build_logo_light.png
          html_body: |
            <!DOCTYPE html>
            <html>
              <body style="font-family: Arial, sans-serif; color: #333;">
                <div style="max-width: 600px; margin: 20px auto; border: 1px solid #ddd; padding: 20px;">
                  <div style="text-align: center; margin-bottom: 20px;">
                    <img src="cid:hai_build_logo_light.png" alt="Header Logo" style="max-width: 200px;">
                  </div>
                  <h2 style="color: #2c3e50;">Existing PR Updated</h2>
                  <p>New changes found in <b>Cline Repository</b>.</p>
                  <p>The existing sync PR has been updated with the latest commits.</p>
                  <p>View the update here: <a href="${{ steps.sync_upstream.outputs.pr_url }}">${{ steps.sync_upstream.outputs.pr_url }}</a></p>
                </div>
              </body>
            </html>
            
