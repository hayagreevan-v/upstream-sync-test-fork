name: Upstream Auto Sync via PR
on:
  schedule:
    - cron: '0 0 * * *' # Runs daily.
  workflow_dispatch:  

jobs:
  upstream-sync:
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check and Sync Upstream
        id: sync_upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_REPO: "hayagreevan-presidio/upstream-sync-test-upstream"
          FORK_REPO: "hayagreevan-v/upstream-sync-test-fork"
        run: |
          # 1. Setup Git Identity (Required for merge commits)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 2. Setup upstream remote and fetch
          # We check if 'upstream' exists; if not, add it. If it does, update the URL.

          if ! git remote | grep -q 'upstream'; then
            echo "Adding upstream remote..."
            git remote add upstream https://github.com/${UPSTREAM_REPO}.git
          else
            echo "Upstream remote already exists, updating URL..."
            git remote set-url upstream https://github.com/${UPSTREAM_REPO}.git
          fi

          git fetch upstream main

          # 3. Checkout to upstream-main branch
          # This ensures we are merging upstream into our upstream-main branch
          git checkout upstream-main 

          # 4. Check if upstream is actually ahead of our main
          LOCAL_HASH=$(git rev-parse HEAD)
          UPSTREAM_HASH=$(git rev-parse upstream/main)

          if [ "$LOCAL_HASH" = "$UPSTREAM_HASH" ]; then
            echo "No changes found. Skipping sync."
            exit 0
          fi

          # 5. Check if a PR already exists with this title
          # We get the count of open PRs with this title
          PR_COUNT=$(gh pr list --repo $FORK_REPO --state open --search "Merge from Cline" --json id --jq '. | length')
          
          # 6. Merge upstream into the sync branch
          echo "New commits detected. Merging..."
          git merge upstream/main --no-edit
          
          # 7. Push the branch (use force-with-lease to update existing PR branch safely)
          git push origin upstream-main

          EXISTING_PR_URL=$(gh pr list --repo $FORK_REPO --state open --search "Merge from Cline" --json url --jq '.[0].url')

          if [ -z "$EXISTING_PR_URL" ]; then
            echo "Creating new Pull Request..."
            NEW_PR_URL=$(gh pr create \
              --repo $FORK_REPO \
              --title "Merge from Cline" \
              --body "This is an automated PR to sync changes from cline repo." \
              --base main \
              --head upstream-main)
            
            echo "pr_url=$NEW_PR_URL" >> $GITHUB_OUTPUT
            echo "pr_created=true" >> $GITHUB_OUTPUT
          else
            echo "Existing PR updated with new commits."
            echo "pr_url=$EXISTING_PR_URL" >> $GITHUB_OUTPUT
            echo "new_changes_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Send PR created Email Notification
        if: steps.sync_upstream.outputs.pr_created == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "New Upstream Sync PR for ${{ github.repository }}"
          to: drmarsqueen@gmail.com,hayagreevanvk@gmail.com
          from: HAI Build Codegen - GitHub Actions
          body: |
            Hello Team,

            This is an automated notification to inform you that new commits have been detected in the upstream Cline repository. 
            
            A new Pull Request has been successfully generated to synchronize your fork with these changes.

            Repository: ${{ github.repository }}
            Action: New Pull Request Created
            PR Link: ${{ steps.sync_upstream.outputs.pr_url }}

            Please review the changes and merge at your earliest convenience to keep the fork up to date.

            Regards,
            GitHub Actions Runner


      - name: Send New Changes found Email Notification
        if: steps.sync_upstream.outputs.new_changes_found == 'true' 
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Existing Sync PR Updated for ${{ github.repository }}"
          to: drmarsqueen@gmail.com,hayagreevanvk@gmail.com
          from: HAI Build Codegen - GitHub Actions
          body: |
            Hello Team,

            New updates have been detected in the upstream Cline repository. Since a synchronization Pull Request was already open, it has been automatically updated with the latest commits.

            Repository: ${{ github.repository }}
            Action: Existing PR Updated
            PR Link: ${{ steps.sync_upstream.outputs.pr_url }}

            The pull request is ready for your final review and merge.

            Regards,
            GitHub Actions Runner
            
            
